global
    #log /dev/log    local5
    #log /dev/log    local5 notice
    #stats socket /run/haproxy/admin.sock mode 660 level admin
    #stats timeout 30s


# Share config for next blocks using a defaults block
defaults
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 5s
    timeout client  50s
    timeout server  50s

    balance roundrobin

    option tcp-check
    timeout check 500ms

    default-server inter 3s


listen stats
    bind *:8081
    stats enable
    stats uri '/haproxy'
    stats show-desc 'Zucchini'
    stats show-legends
    stats show-node
    stats realm 'Auth required'
    stats auth foo:bar
    stats admin if TRUE


frontend frontend
    ### Add X-Forwarded-For header
    ### option  forwardfor

    ### maxconn 800
    bind *:8080

    errorfile 503 '/usr/local/etc/haproxy/responses/503.http'

    default_backend app


backend app
    option httpchk GET '/healthcheck'
    http-check send-state

    # Add the correlation ID header if not defined on the origin request
    acl has_correlation_id_header req.hdr(X-Correlation-ID) -m found
    http-request set-header 'X-Correlation-ID' 'CID-%Ts-%rt' unless has_correlation_id_header
    
    # Add the exchange ID header if not defined on the origin request
    acl has_exchange_id_header req.hdr(X-Exchange-ID) -m found
    http-request set-header 'X-Exchange-ID' 'EX-%Ts-%rt' unless has_exchange_id_header
    
    # HaProxy tracability
    http-response add-header 'X-About-HaProxy' '%H %f/%b/%s %fi:%fp/%si:%sp'

    # Redirect web sockets to one server only (state not shared by zucchini)
    acl is_connection_upgrade req.hdr(Connection) -i Upgrade
    acl is_websocket req.hdr(Upgrade) -i WebSocket
    use-server zucchini3 if is_connection_upgrade is_websocket

    server zucchini1 zucchini1:8080 check port 8081 weight 2
    server zucchini2 zucchini2:8080 check port 8081 weight 2
    server zucchini3 zucchini3:8080 check port 8081 weight 1
